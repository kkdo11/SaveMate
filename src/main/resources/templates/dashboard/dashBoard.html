<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>SAVEMATE - ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <script>
    function csrfFetch(url, options = {}) {
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
      options.headers = {
        'Content-Type': 'application/json',
        [csrfHeader]: csrfToken,
        ...(options.headers || {})
      };
      return fetch(url, {
        ...options,
        credentials: 'same-origin'
      });
    }
  </script>
</head>

<body class="bg-gradient-to-r from-indigo-100 via-purple-100 to-pink-100 text-gray-800 font-sans leading-relaxed min-h-screen">

<!-- âœ… Header -->
<header class="bg-white shadow border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center flex-wrap">
    <h1 class="text-lg font-semibold text-gray-700">
      <span th:if="${#authorization.expression('isAuthenticated()')}" th:text="${#authentication.principal.username}">ì‚¬ìš©ì</span>
      <span th:if="${#authorization.expression('isAnonymous()')}">ê²ŒìŠ¤íŠ¸</span>
      ë‹˜ì˜ <span class="text-purple-600">SAVEMATE</span>
    </h1>
    <!-- ì˜¤ë¥¸ìª½: ë„¤ë¹„ê²Œì´ì…˜ + ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
    <div class="flex flex-wrap items-center space-x-6 mt-4 lg:mt-0">
      <nav>
        <ul class="flex space-x-6 text-base text-gray-700 font-semibold">
          <li><a href="/dashboard/page" class="hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a></li>
          <li><a href="/spending/page" class="hover:text-purple-600">ì†Œë¹„ë‚´ì—­</a></li>
          <li><a href="/budget/page" class="hover:text-purple-600">ì˜ˆì‚° ì„¤ì •</a></li>
          <li><a href="/goal/page" class="hover:text-purple-600">ì €ì¶•</a></li>
          <li><a href="/ai/page" class="hover:text-purple-600">AIë¶„ì„</a></li>
          <li><a href="/user/myPage" class="hover:text-purple-600">ë§ˆì´í˜ì´ì§€</a></li>
        </ul>
      </nav>
      <div>
        <form th:if="${#authorization.expression('isAuthenticated()')}" th:action="@{/user/logout}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
        <a th:if="${#authorization.expression('isAnonymous()')}" th:href="@{/user/login}"
           class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">ë¡œê·¸ì¸</a>
      </div>
    </div>
  </div>
</header>

<!-- âœ… MAIN DASHBOARD SECTION (í†¤ í†µì¼ ì ìš©) -->
<main class="max-w-7xl mx-auto p-6 mt-10 bg-gray-50 rounded-lg shadow-md border border-gray-200">

  <h2 class="text-2xl font-bold mb-8 text-gray-800 flex items-center gap-2">
    ğŸ“Š ì˜ˆì‚° ëŒ€ì‹œë³´ë“œ
  </h2>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Pie Chart Card -->
    <section class="p-5 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
      <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
        ğŸ¯ ì¹´í…Œê³ ë¦¬ë³„ ì†Œë¹„ ë¹„ìœ¨
      </h3>
      <div class="flex-grow flex items-center justify-center">
        <canvas id="category-pie-chart" class="w-full max-h-[340px]"></canvas>
      </div>
    </section>

    <!-- Bar Chart Card -->
    <section class="p-5 bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
      <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
        ğŸ“ˆ ì›”ë³„ ì˜ˆì‚° vs ì‚¬ìš©
      </h3>
      <div class="flex-grow">
        <canvas id="monthly-bar-chart" class="w-full h-full"></canvas>
      </div>
    </section>
  </div>
</main>


<!-- âœ… CHART SCRIPT SECTION -->
<script>
  let pieChartInstance = null;
  let barChartInstance = null;

  window.onload = () => {
    fetch('/dashboardAPI/usage-summary')
            .then(res => res.json())
            .then(data => {
              if (!data) throw new Error("No data returned");
              renderPieChart(data.categoryUsage);
              renderBarChart(data.monthlyBudget);
            })
            .catch(err => {
              alert("ğŸ“‰ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
              fallbackChart("category-pie-chart", "ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì—†ìŒ");
              fallbackChart("monthly-bar-chart", "ì›”ë³„ ì˜ˆì‚° ë°ì´í„° ì—†ìŒ");
            });
  };

  function fallbackChart(id, message) {
    const canvas = document.getElementById(id);
    const parent = canvas.parentElement;
    canvas.remove();
    const fallback = document.createElement('div');
    fallback.className = "text-center text-sm text-gray-500 w-full py-16";
    fallback.textContent = message;
    parent.appendChild(fallback);
  }

  function renderPieChart(categoryData) {
    const ctx = document.getElementById('category-pie-chart').getContext('2d');
    if (pieChartInstance) pieChartInstance.destroy();
    pieChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(categoryData),
        datasets: [{
          data: Object.values(categoryData),
          backgroundColor: [
            '#6366F1', '#EC4899', '#F59E0B', '#10B981',
            '#EF4444', '#3B82F6', '#8B5CF6', '#F87171'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#4B5563',
              padding: 20
            }
          }
        }
      }
    });
  }

  function renderBarChart(monthlyData) {
    if (!monthlyData || monthlyData.length === 0) return;
    const ctx = document.getElementById('monthly-bar-chart').getContext('2d');
    if (barChartInstance) barChartInstance.destroy();

    const maxVal = Math.max(...monthlyData.flatMap(m => [m.budget, m.used])) * 1.1;
    barChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: monthlyData.map(item => item.month),
        datasets: [
          {
            label: 'ì˜ˆì‚°',
            backgroundColor: '#4F46E5',
            data: monthlyData.map(item => item.budget)
          },
          {
            label: 'ì‚¬ìš©',
            backgroundColor: '#EF4444',
            data: monthlyData.map(item => item.used)
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: maxVal,
            ticks: {
              callback: value => value.toLocaleString() + "ì›",
              color: '#6B7280'
            },
            grid: {
              color: '#E5E7EB'
            }
          },
          x: {
            ticks: { color: '#6B7280' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#374151'
            }
          }
        }
      }
    });
  }
</script>

</body>
</html>
