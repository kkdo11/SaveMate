<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SAVEMATE - ì†Œë¹„ë‚´ì—­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <!-- âœ¨ HTML head ì•ˆìª½ì— CSRF ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <script>// âœ… CSRF ì„¤ì • ìë™ í¬í•¨ fetch ë˜í¼
    function csrfFetch(url, options = {}) {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        const defaultHeaders = {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        };

        options.headers = { ...defaultHeaders, ...(options.headers || {}) };

        return fetch(url, options);
    }
    </script>

</head>
<body class="bg-gray-50 font-sans">

<!-- Header -->
<!-- ì‚¬ìš©ì ì´ë¦„ ë° ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ, ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ -->
<!-- Header -->
<header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">

        <div class="flex items-center space-x-4">
            <div class="w-10 h-10 bg-purple-300 rounded-full flex items-center justify-center">
                <span class="text-white font-bold">A</span>
            </div>

            <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ì‚¬ìš©ì ì´ë¦„ ì¶œë ¥ -->
            <h1 class="text-xl font-semibold">
        <span th:if="${#authorization.expression('isAuthenticated()')}"
              th:text="${#authentication.principal.username}">ì‚¬ìš©ì</span>
                <span th:if="${#authorization.expression('isAnonymous()')}">ê²ŒìŠ¤íŠ¸</span>
                ë‹˜ì˜ <span class="text-purple-600">SAVEMATE</span>
            </h1>
        </div>

        <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
        <div>
            <!-- âœ… ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
            <form th:if="${#authorization.expression('isAuthenticated()')}" th:action="@{/user/logout}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </form>

            <!-- âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ: ë¡œê·¸ì¸ ë²„íŠ¼ -->
            <a th:if="${#authorization.expression('isAnonymous()')}"
               th:href="@{/user/login}"
               class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600">
                ë¡œê·¸ì¸
            </a>
        </div>

    </div>
</header>


<!-- Navigation Tabs -->
<nav class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4">
        <ul class="flex space-x-8 py-3">
            <li><a href="#" class="text-gray-500 hover:text-purple-600">ì†Œë¹„ë‚´ì—­</a></li>
            <li><a href="#" class="text-gray-500 hover:text-purple-600">ì˜ˆì‚° ì„¤ì •</a></li>
            <li><a href="#" class="text-gray-500 hover:text-purple-600">ì €ì¶•</a></li>
            <li><a href="#" class="text-gray-500 hover:text-purple-600">AI ë¶„ì„</a></li>
            <li><a href="/mypage" class="text-gray-500 hover:text-purple-600">ë§ˆì´í˜ì´ì§€</a></li>
        </ul>
    </div>
</nav>

<!-- Main Container -->
<div class="max-w-5xl mx-auto p-6 bg-white rounded-lg shadow mt-8">
    <h2 class="text-2xl font-semibold mb-4">ì†Œë¹„ë‚´ì—­</h2>

    <!-- í•„í„° -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div>
            <label class="text-sm">ì›”ë³„</label>
            <input type="month" id="filterMonth" class="block border rounded px-3 py-2 mt-1" />
        </div>
        <div>
            <label class="text-sm">ì¹´í…Œê³ ë¦¬</label>
            <select id="filterCategory" class="block border rounded px-3 py-2 mt-1">
                <option value="">ì „ì²´</option>
                <option value="ì‹ë¹„">ì‹ë¹„</option>
                <option value="êµí†µ/ì´ë™">êµí†µ/ì´ë™</option>
                <option value="ì£¼ê±°/ê³µê³¼ê¸ˆ">ì£¼ê±°/ê³µê³¼ê¸ˆ</option>
                <option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option>
                <option value="ì˜ë¥˜/ë¯¸ìš©">ì˜ë¥˜/ë¯¸ìš©</option>
                <option value="ì˜ë£Œ/ê±´ê°•">ì˜ë£Œ/ê±´ê°•</option>
                <option value="êµìœ¡/ë„ì„œ">êµìœ¡/ë„ì„œ</option>
                <option value="ì˜ë¥˜/ë¯¸ìš©">ì˜ë¥˜/ë¯¸ìš©</option>
                <option value="ì—¬ê°€/ë¬¸í™”">ì—¬ê°€/ë¬¸í™”</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
        </div>
        <div class="self-end">
            <button onclick="applyFilters()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">í•„í„° ì ìš©</button>
        </div>
    </div>

    <!-- ë“±ë¡/ìˆ˜ì • í¼ -->
    <!-- ë“±ë¡/ìˆ˜ì • í¼ -->
    <form id="spendingForm" class="space-y-4 mb-8">
        <h3 id="formTitle" class="text-lg font-medium">ì§€ì¶œ ë“±ë¡</h3>
        <input type="hidden" id="spendingId" />

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div class="col-span-1 md:col-span-1">
                <input type="text" id="name" placeholder="ì´ë¦„" class="border px-3 py-2 rounded w-full" />
                <span id="nameError" class="text-red-500 text-sm hidden">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            </div>
            <div class="col-span-1 md:col-span-1">
                <select id="category" class="border px-3 py-2 rounded w-full">
                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                    <option value="ì‹ë¹„">ì‹ë¹„</option>
                    <option value="êµí†µ/ì´ë™">êµí†µ/ì´ë™</option>
                    <option value="ì£¼ê±°/ê³µê³¼ê¸ˆ">ì£¼ê±°/ê³µê³¼ê¸ˆ</option>
                    <option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option>
                    <option value="ì˜ë¥˜/ë¯¸ìš©">ì˜ë¥˜/ë¯¸ìš©</option>
                    <option value="ì˜ë£Œ/ê±´ê°•">ì˜ë£Œ/ê±´ê°•</option>
                    <option value="êµìœ¡/ë„ì„œ">êµìœ¡/ë„ì„œ</option>
                    <option value="ì˜ë¥˜/ë¯¸ìš©">ì˜ë¥˜/ë¯¸ìš©</option>
                    <option value="ì—¬ê°€/ë¬¸í™”">ì—¬ê°€/ë¬¸í™”</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <span id="categoryError" class="text-red-500 text-sm hidden">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
            </div>
            <div class="col-span-1">
                <input type="number" id="amount" placeholder="ê¸ˆì•¡" min="1" class="border px-3 py-2 rounded w-full" />
                <span id="amountError" class="text-red-500 text-sm hidden">ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            </div>
            <div class="col-span-2">
                <input type="text" id="description" placeholder="ì„¤ëª…" class="border px-3 py-2 rounded w-full" />
                <span id="descError" class="text-red-500 text-sm hidden">ê°„ë‹¨í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”.</span>
            </div>
            <div class="col-span-1">
                <input type="date" id="date" class="border px-3 py-2 rounded w-full" />
                <span id="dateError" class="text-red-500 text-sm hidden">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
            </div>
        </div>

        <div>
            <button type="submit" id="submitButton" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mr-2">ì €ì¥</button>
            <button type="button" onclick="resetForm()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
        </div>
    </form>


    <!-- ì†Œë¹„ë‚´ì—­ ì¹´ë“œ ëª©ë¡ -->
    <div id="spendingListWrapper" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 bg-white" id="spendingList">
            <thead class="bg-gray-100">
            <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">ì´ë¦„</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">ì¹´í…Œê³ ë¦¬</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">ê¸ˆì•¡</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">ì„¤ëª…</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">ë‚ ì§œ</th>
                <th class="px-4 py-2 text-right text-sm font-semibold text-gray-600">ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="spendingListBody">
            <!-- Row render target -->
            </tbody>
        </table>
    </div>


    <div id="loading" class="text-center hidden">ë¡œë”© ì¤‘...</div>
</div>

<script>
    const apiUrl = '/spendingAPI';
    let filterMonth = '';
    let filterCategory = '';

    // ğŸš€ ì´ˆê¸° ì¡°íšŒ
    window.onload = () => getSpendings();

    function applyFilters() {
        filterMonth = document.getElementById('filterMonth').value;
        filterCategory = document.getElementById('filterCategory').value;
        getSpendings();
    }

    function getSpendings() {
        document.getElementById('loading').classList.remove('hidden');
        const url = `${apiUrl}?month=${filterMonth}&category=${filterCategory}`;

        fetch(url, {
            redirect: "manual"  // ë¦¬ë””ë ‰ì…˜ ë°©ì§€
        })
            .then(res => {
                if (res.status === 0 || res.type === 'opaqueredirect') {
                    alert("ğŸ”’ ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                    throw new Error("Unauthorized Redirect");
                }

                if (res.status === 401) {
                    alert("ğŸ”’ ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                    throw new Error("Unauthorized");
                }

                if (!res.ok) {
                    throw new Error("ì¡°íšŒ ì‹¤íŒ¨");
                }

                return res.json();  // ì—¬ê¸°ëŠ” ì´ì œ JSONì¼ ë•Œë§Œ ì‹¤í–‰ë¨
            })
            .then(renderSpendings)
            .catch(err => {
                if (err.message !== "Unauthorized" && err.message !== "Unauthorized Redirect") {
                    alert("âŒ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
                }
            })
            .finally(() => {
                document.getElementById('loading').classList.add('hidden');
            });
    }


    function renderSpendings(data) {
        const list = document.getElementById('spendingListBody');
        list.innerHTML = '';

        data.forEach(spending => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';

            row.innerHTML = `
            <td class="px-4 py-2 text-sm text-gray-800">${spending.name}</td>
            <td class="px-4 py-2 text-sm text-gray-700">${spending.category}</td>
            <td class="px-4 py-2 text-sm text-gray-700">${spending.amount.toLocaleString()}ì›</td>
            <td class="px-4 py-2 text-sm text-gray-600">${spending.description || '-'}</td>
            <td class="px-4 py-2 text-sm text-gray-600">${spending.date}</td>
            <td class="px-4 py-2 text-sm text-right space-x-2">
                <button onclick="editSpending('${spending.id?.$oid || spending.id}')" class="bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-500">ìˆ˜ì •</button>
                <button onclick="deleteSpending('${spending.id?.$oid || spending.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">ì‚­ì œ</button>
            </td>
        `;

            list.appendChild(row);
        });
    }



    // ğŸ” ë“±ë¡ & ìˆ˜ì •
    document.getElementById('spendingForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const name = document.getElementById('name').value.trim();
        const category = document.getElementById('category').value.trim();
        const amount = document.getElementById('amount').value.trim();
        const description = document.getElementById('description').value.trim();
        const date = document.getElementById('date').value.trim();

        let isValid = true;

        // ìœ íš¨ì„± ê²€ì‚¬ ë° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        if (!name) {
            document.getElementById('nameError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('nameError').classList.add('hidden');
        }

        if (!category) {
            document.getElementById('categoryError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('categoryError').classList.add('hidden');
        }

        if (!amount || isNaN(amount) || parseInt(amount) < 1) {
            document.getElementById('amountError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('amountError').classList.add('hidden');
        }

        if (!description) {
            document.getElementById('descError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('descError').classList.add('hidden');
        }

        if (!date) {
            document.getElementById('dateError').classList.remove('hidden');
            isValid = false;
        } else {
            document.getElementById('dateError').classList.add('hidden');
        }

        // ì—ëŸ¬ ìˆìœ¼ë©´ ì „ì†¡ ë§‰ìŒ
        if (!isValid) return;

        const id = document.getElementById('spendingId').value;
        const spending = {
            name,
            category,
            amount: parseInt(amount),
            description: document.getElementById('description').value,
            date
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${apiUrl}/${id}` : apiUrl;

        csrfFetch(url, {
            method,
            body: JSON.stringify(spending)
        })
            .then(res => res.json())
            .then(() => {
                alert('âœ… ì €ì¥ ì™„ë£Œ');
                resetForm();
                getSpendings();
            })
            .catch(err => alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + err));
    });

    // í¼ ë¦¬ì…‹ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ë„ ì´ˆê¸°í™”
    function resetForm() {
        document.getElementById('spendingForm').reset();
        document.getElementById('spendingId').value = '';
        document.getElementById('formTitle').innerText = 'ì§€ì¶œ ë“±ë¡';

        ['nameError', 'categoryError', 'amountError', 'dateError'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
    }


    function editSpending(id) {
        fetch(`${apiUrl}/${id}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('formTitle').innerText = 'ì§€ì¶œ ìˆ˜ì •';
                document.getElementById('spendingId').value = data.id;
                document.getElementById('name').value = data.name;
                document.getElementById('category').value = data.category;
                document.getElementById('amount').value = data.amount;
                document.getElementById('description').value = data.description;
                document.getElementById('date').value = data.date;
            });
    }

    // âŒ ì‚­ì œ
    function deleteSpending(id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        csrfFetch(`${apiUrl}/${id}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(() => {
                alert('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
                getSpendings();
            })
            .catch(err => alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + err));
    }

    // function resetForm() {
    //     document.getElementById('spendingForm').reset();
    //     document.getElementById('spendingId').value = '';
    //     document.getElementById('formTitle').innerText = 'ì§€ì¶œ ë“±ë¡';
    // }


    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì†Œë¹„ë‚´ì—­ ëª©ë¡ ì¡°íšŒ
    window.onload = getSpendings;
</script>

</body>
</html>

