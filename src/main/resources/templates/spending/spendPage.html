<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SAVEMATE - ì†Œë¹„ë‚´ì—­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <script th:inline="javascript">
        const isAuthenticated = /*[[${isAuthenticated}]]*/ false;
        const username = /*[['${username}']]*/ 'ê²ŒìŠ¤íŠ¸';
    </script>
</head>

<body class="bg-gray-50 font-sans">
<!-- Header -->
<!-- âœ… Header -->
<header class="bg-white shadow border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center flex-wrap">
        <h1 class="text-lg font-semibold text-gray-700">
            <span th:if="${#authorization.expression('isAuthenticated()')}" th:text="${#authentication.principal.username}">ì‚¬ìš©ì</span>
            <span th:if="${#authorization.expression('isAnonymous()')}">ê²ŒìŠ¤íŠ¸</span>
            ë‹˜ì˜ <span class="text-purple-600">SAVEMATE</span>
        </h1>
        <!-- ì˜¤ë¥¸ìª½: ë„¤ë¹„ê²Œì´ì…˜ + ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
        <div class="flex flex-wrap items-center space-x-6 mt-4 lg:mt-0">
            <nav>
                <ul class="flex space-x-6 text-base text-gray-700 font-semibold">
                    <li><a href="/dashboard/page" class="hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a></li>
                    <li><a href="/spending/page" class="hover:text-purple-600">ì†Œë¹„ë‚´ì—­</a></li>
                    <li><a href="/budget/page" class="hover:text-purple-600">ì˜ˆì‚° ì„¤ì •</a></li>
                    <li><a href="/goal/page" class="hover:text-purple-600">ì €ì¶•</a></li>
                    <li><a href="/ai/page" class="hover:text-purple-600">AIë¶„ì„</a></li>
                    <li><a href="/user/myPage" class="hover:text-purple-600">ë§ˆì´í˜ì´ì§€</a></li>
                </ul>
            </nav>
            <div>
                <form th:if="${#authorization.expression('isAuthenticated()')}" th:action="@{/user/logout}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
                <a th:if="${#authorization.expression('isAnonymous()')}" th:href="@{/user/login}"
                   class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </div>
</header>

<main class="max-w-5xl mx-auto p-6 bg-white rounded-lg shadow mt-8">
    <h2 class="text-2xl font-semibold mb-6">ì†Œë¹„ë‚´ì—­</h2>

    <!-- ğŸ” í•„í„° -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div>
            <label class="text-sm font-medium">ì›”ë³„</label>
            <input type="month" id="filterMonth" class="block border rounded px-3 py-2 mt-1" />
        </div>
        <div>
            <label class="text-sm font-medium">ì¹´í…Œê³ ë¦¬</label>
            <select id="filterCategory" class="block border rounded px-3 py-2 mt-1">
                <option value="">ì „ì²´</option>
                <option value="ì‹ë¹„">ì‹ë¹„</option>
                <option value="êµí†µ/ì´ë™">êµí†µ/ì´ë™</option>
                <option value="ì£¼ê±°/ê³µê³¼ê¸ˆ">ì£¼ê±°/ê³µê³¼ê¸ˆ</option>
                <option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option>
                <option value="ì˜ë¥˜/ë¯¸ìš©">ì˜ë¥˜/ë¯¸ìš©</option>
                <option value="ì˜ë£Œ/ê±´ê°•">ì˜ë£Œ/ê±´ê°•</option>
                <option value="êµìœ¡/ë„ì„œ">êµìœ¡/ë„ì„œ</option>
                <option value="ì—¬ê°€/ë¬¸í™”">ì—¬ê°€/ë¬¸í™”</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
        </div>
        <div class="self-end">
            <button onclick="applyFilters()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">í•„í„° ì ìš©</button>
        </div>
    </div>

    <!-- ğŸ“ ì§€ì¶œ ë“±ë¡ í¼ -->
    <form id="spendingForm" class="space-y-4 mb-10">
        <h3 id="formTitle" class="text-lg font-medium">ì§€ì¶œ ë“±ë¡</h3>
        <input type="hidden" id="spendingId" />
        <p id="authNotice" class="hidden text-sm text-red-500 font-medium">âš ï¸ ë¡œê·¸ì¸ í›„ ì§€ì¶œì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div><input type="text" id="name" placeholder="ì´ë¦„" class="border px-3 py-2 rounded w-full" /></div>
            <div>
                <select id="category" class="border px-3 py-2 rounded w-full">
                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                    <option value="ì‹ë¹„">ì‹ë¹„</option>
                    <option value="êµí†µ/ì´ë™">êµí†µ/ì´ë™</option>
                    <option value="ì£¼ê±°/ê³µê³¼ê¸ˆ">ì£¼ê±°/ê³µê³¼ê¸ˆ</option>
                    <option value="ìƒí™œìš©í’ˆ">ìƒí™œìš©í’ˆ</option>
                    <option value="ì˜ë¥˜/ë¯¸ìš©">ì˜ë¥˜/ë¯¸ìš©</option>
                    <option value="ì˜ë£Œ/ê±´ê°•">ì˜ë£Œ/ê±´ê°•</option>
                    <option value="êµìœ¡/ë„ì„œ">êµìœ¡/ë„ì„œ</option>
                    <option value="ì—¬ê°€/ë¬¸í™”">ì—¬ê°€/ë¬¸í™”</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
            </div>
            <div><input type="number" id="amount" placeholder="ê¸ˆì•¡" min="1" class="border px-3 py-2 rounded w-full" /></div>
            <div><input type="text" id="description" placeholder="ì„¤ëª…" class="border px-3 py-2 rounded w-full" /></div>
            <div><input type="date" id="date" class="border px-3 py-2 rounded w-full" /></div>
            <div class="flex space-x-2">
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ì €ì¥</button>
                <button type="button" onclick="resetForm()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
            </div>
        </div>
    </form>

    <!-- ğŸ“ƒ ì†Œë¹„ë‚´ì—­ ë¦¬ìŠ¤íŠ¸í˜• UI -->
    <section id="spendingList" class="space-y-4">
        <!-- ê° í•­ëª©ì´ JSë¡œ ì‚½ì…ë¨ -->
    </section>

    <div id="loading" class="text-center hidden text-sm text-gray-500 py-6">ë¡œë”© ì¤‘...</div>
</main>

<script>
    const apiUrl = '/spendingAPI';
    let filterMonth = '';
    let filterCategory = '';
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    async function csrfFetch(url, options = {}) {
        options.headers = {
            ...options.headers,
            [csrfHeader]: csrfToken,
        };

        try {
            const res = await fetch(url, options);

            // ğŸ§Š 401ì´ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
            if (res.status === 401) {
                return null;
            }

            const contentType = res.headers.get("content-type") || "";
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);

            if (contentType.includes("application/json")) {
                return await res.json();
            }

            return null; // ğŸ“¦ JSON ì•„ë‹Œ ê²½ìš°ë„ ë¬´ì‹œ
        } catch (err) {
            // âŒ ì„œë²„ ì—ëŸ¬ ë“±ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ ì œê±°
            // console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
            return null; // ğŸ”• ëª¨ë“  ì—ëŸ¬ë„ ì¡°ìš©íˆ ì²˜ë¦¬
        }
    }


    window.onload = () => {
        if (!isAuthenticated) {
            document.getElementById('authNotice').classList.remove('hidden');

            document.querySelectorAll('#spendingForm input, #spendingForm select, #spendingForm button').forEach(el => {
                el.disabled = true;
                el.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        getSpendings();
    };

    function applyFilters() {
        filterMonth = document.getElementById('filterMonth').value;
        filterCategory = document.getElementById('filterCategory').value;
        getSpendings();
    }

    async function getSpendings() {
        document.getElementById('loading').classList.remove('hidden');
        const url = `${apiUrl}?month=${filterMonth}&category=${filterCategory}`;

        try {
            const data = await csrfFetch(url);
            if (data) {
                renderSpendings(data);
            } else {
                // âŒ ì•„ë¬´ ê²ƒë„ ì•ˆí•¨ (ì¹¨ë¬µ)
            }
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }


    function renderSpendings(data) {
        const list = document.getElementById('spendingList');
        list.innerHTML = '';

        data.forEach(sp => {
            const item = document.createElement('div');
            item.className = "p-4 rounded-lg bg-white shadow flex flex-col md:flex-row md:items-center md:justify-between hover:bg-gray-50 transition";

            item.innerHTML = `
                <div>
                  <h4 class="text-lg font-semibold text-gray-800">${sp.name}</h4>
                  <p class="text-sm text-gray-500 mt-1">
                    ğŸ“ ${sp.category} | ğŸ’° ${sp.amount.toLocaleString()}ì› | ğŸ“… ${sp.date}
                  </p>
                  <p class="text-sm text-gray-600 mt-1">${sp.description || '-'}</p>
                </div>
                <div class="flex space-x-2 mt-4 md:mt-0">
                  <button onclick="editSpending('${sp.id?.$oid || sp.id}')" class="edit-btn bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-500">ìˆ˜ì •</button>
                  <button onclick="deleteSpending('${sp.id?.$oid || sp.id}')" class="delete-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">ì‚­ì œ</button>
                </div>
            `;

            list.appendChild(item);

            if (!isAuthenticated) {
                item.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
            }
        });
    }

    document.getElementById('spendingForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!isAuthenticated) {
            alert("â— ë¡œê·¸ì¸ í›„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        const name = document.getElementById('name').value.trim();
        const category = document.getElementById('category').value.trim();
        const amount = parseInt(document.getElementById('amount').value);
        const description = document.getElementById('description').value.trim();
        const date = document.getElementById('date').value.trim();

        if (!name || !category || !date || !amount || amount <= 0) {
            alert("âš ï¸ ëª¨ë“  í•­ëª©ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const spending = { name, category, amount, description, date };
        const id = document.getElementById('spendingId').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${apiUrl}/${id}` : apiUrl;

        try {
            await csrfFetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(spending),
            });
            alert('âœ… ì €ì¥ ì™„ë£Œ');
            resetForm();
            getSpendings();
        } catch (err) {
            alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + err.message);
        }
    });

    async function editSpending(id) {
        if (!isAuthenticated) return alert("â— ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");

        try {
            const data = await csrfFetch(`${apiUrl}/${id}`);
            if (data) {
                document.getElementById('formTitle').innerText = 'ì§€ì¶œ ìˆ˜ì •';
                document.getElementById('spendingId').value = data.id;
                document.getElementById('name').value = data.name;
                document.getElementById('category').value = data.category;
                document.getElementById('amount').value = data.amount;
                document.getElementById('description').value = data.description;
                document.getElementById('date').value = data.date;
            }
        } catch (err) {
            alert('âŒ ìˆ˜ì • ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message);
        }
    }

    async function deleteSpending(id) {
        if (!isAuthenticated) return alert("â— ë¡œê·¸ì¸ í›„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            await csrfFetch(`${apiUrl}/${id}`, {
                method: 'DELETE'
            });
            alert('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
            getSpendings();
        } catch (err) {
            alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
        }
    }

    function resetForm() {
        document.getElementById('spendingForm').reset();
        document.getElementById('spendingId').value = '';
        document.getElementById('formTitle').innerText = 'ì§€ì¶œ ë“±ë¡';
    }
</script>

</body>
</html>
