<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <meta charset="UTF-8">
  <title>회원가입</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ajaxSend(function (e, xhr, options) {
      const token = $("meta[name='_csrf']").attr("content");
      const header = $("meta[name='_csrf_header']").attr("content");
      xhr.setRequestHeader(header, token);
    });
  </script>
  <script>



    $(document).ready(function () {
      let emailVerified = false;

      // ID 중복 확인
      $("#btnUserId").click(function () {
        const user_id = $("#user_id").val().trim();
        const $msg = $("#userIdMsg");

        if (!user_id) {
          $msg.text("아이디를 입력해주세요.").removeClass().addClass("text-sm text-red-500");
          return;
        }

        $.ajax({
          url: "/user/getUserIdExists",
          type: "get",
          data: { user_id },
          success: function (res) {
            if (res.exist_yn === "Y") {
              $msg.text("이미 사용 중인 아이디입니다.").removeClass().addClass("text-sm text-red-500");
            } else {
              $msg.text("사용 가능한 아이디입니다.").removeClass().addClass("text-sm text-green-600");
            }
          }
        });
      });

      // 이메일 인증코드 발송
      $("#btnSendVerification").click(function () {
        const email = $("#email").val().trim();
        const $msg = $("#emailMsg");

        if (!email) {
          $msg.text("이메일을 입력해주세요.").removeClass().addClass("text-sm text-red-500");
          return;
        }

        // ✅ 이메일 중복 여부 먼저 체크
        $.ajax({
          url: "/user/getEmailExists",
          type: "POST",
          data: { email },
          success: function (res) {
            if (res.exist_yn === "Y") {
              $msg.text("이미 사용 중인 이메일입니다.").removeClass().addClass("text-sm text-red-500");
              return;
            }

            // ✅ 이메일이 중복되지 않은 경우에만 메일 발송
            $.ajax({
              url: "/user/sendVerificationEmail",
              type: "POST",
              data: { email },
              success: function (res) {
                if (res.msg === "이메일을 확인하세요.") {
                  $msg.text(res.msg).removeClass().addClass("text-sm text-red-600");
                } else {
                  $msg.text(res.msg).removeClass().addClass("text-sm text-green-600");
                }
              },
              error: function () {
                $msg.text("서버 오류가 발생했습니다.").removeClass().addClass("text-sm text-red-500");
              }
            });
          },
          error: function () {
            $msg.text("이메일 중복 체크 중 오류 발생").removeClass().addClass("text-sm text-red-500");
          }
        });
      });


      // 이메일 인증코드 확인
      $("#btnVerifyCode").click(function () {
        const email = $("#email").val().trim();
        const code = $("#emailCode").val().trim();
        const $msg = $("#emailCodeMsg");

        if (!email || !code) {
          $msg.text("이메일과 인증 코드를 모두 입력해주세요.").removeClass().addClass("text-sm text-red-500");
          return;
        }

        $.ajax({
          url: "/user/verifyEmailCode",
          type: "POST",
          data: { email, code },
          success: function (res) {
            if (res.result === 1) {
              emailVerified = true;
              $msg.text("인증 성공").removeClass().addClass("text-sm text-green-600");
            } else {
              $msg.text("인증 실패").removeClass().addClass("text-sm text-red-500");
            }
          }
        });
      });

      // 비밀번호 확인
      $("#password2").on("input", function () {
        const pw1 = $("#password").val();
        const pw2 = $("#password2").val();
        const $msg = $("#pwdCheckMsg");

        if (pw1 !== pw2) {
          $msg.text("비밀번호가 일치하지 않습니다.").removeClass().addClass("text-sm text-red-500");
        } else {
          $msg.text("비밀번호 일치").removeClass().addClass("text-sm text-green-600");
        }
      });

      // 회원가입 버튼 클릭 시 검증
      $("#btnSend").click(function (e) {
        e.preventDefault();

        const user_id = $("#user_id").val().trim();
        const password = $("#password").val().trim();
        const password2 = $("#password2").val().trim();
        const email = $("#email").val().trim();
        const name = $("#name").val().trim();

        let valid = true;

        if (!user_id) {
          $("#userIdMsg").text("아이디를 입력해주세요.").removeClass().addClass("text-sm text-red-500");
          valid = false;
        }

        if (!password || !password2 || password !== password2) {
          $("#pwdCheckMsg").text("비밀번호가 일치하지 않습니다.").removeClass().addClass("text-sm text-red-500");
          valid = false;
        }

        if (!email) {
          $("#emailMsg").text("이메일을 입력해주세요.").removeClass().addClass("text-sm text-red-500");
          valid = false;
        }

        if (!name) {
          $("#nameCheckMsg").text("이름을 입력해주세요.").removeClass().addClass("text-sm text-red-500");
          valid = false;
        }

        if (!emailVerified) {
          $("#emailCodeMsg").text("이메일 인증을 완료해야 합니다.").removeClass().addClass("text-sm text-red-500");
          valid = false;
        }

        if (!valid) return;

        // 회원가입 Ajax
        $.ajax({
          url: "/user/insertUserInfo",
          type: "POST",
          data: { user_id, password, email, name },
          success: function (res) {
            if (res.result === 1) {
              alert(res.msg);
              location.href = "/user/login";
            } else {
              alert("회원가입 실패");
            }
          },
          error: function () {
            alert("회원가입 중 오류 발생");
          }
        });
      });
    });
    $(document).ready(function () {
      console.log("CSRF token:", $("meta[name='_csrf']").attr("content"));
      console.log("CSRF header:", $("meta[name='_csrf_header']").attr("content"));
    });


  </script>

</head>


<body class="bg-white h-screen">
<header class="bg-white shadow border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap justify-between items-center">
    <!-- 왼쪽: 로고 및 사용자 정보 -->
    <div class="flex items-center space-x-3">
      <h1 class="text-lg font-semibold text-gray-700">
        <span th:if="${#authorization.expression('isAuthenticated()')}" th:text="${#authentication.principal.username}">사용자</span>
        <span th:if="${#authorization.expression('isAnonymous()')}">게스트</span>
        님의 <span class="text-purple-600">SAVEMATE</span>
      </h1>
    </div>

    <!-- 오른쪽: 네비게이션 + 로그인/로그아웃 -->
    <div class="flex flex-wrap items-center space-x-6 mt-4 lg:mt-0">
      <nav>
        <ul class="flex space-x-6 text-base text-gray-700 font-semibold">
          <li><a href="/dashboard/page" class="hover:text-purple-600">대시보드</a></li>
          <li><a href="/spending/page" class="hover:text-purple-600">소비내역</a></li>
          <li><a href="/budget/page" class="hover:text-purple-600">예산 설정</a></li>
          <li><a href="/goal/page" class="hover:text-purple-600">저축</a></li>
          <li><a href="/user/myPage" class="hover:text-purple-600">마이페이지</a></li>
        </ul>
      </nav>

      <!-- 로그인/로그아웃 버튼 -->
      <div>
        <form th:if="${#authorization.expression('isAuthenticated()')}" th:action="@{/user/logout}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">로그아웃</button>
        </form>
        <a th:if="${#authorization.expression('isAnonymous()')}" th:href="@{/user/login}"
           class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">로그인</a>
      </div>
    </div>
  </div>
</header>
<div class="flex h-full">
  <!-- Left: Form -->
  <div class="w-1/2 flex items-center justify-center px-10">
    <form id="registerForm" th:action="@{/user/register}" method="post" class="w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold mb-6 text-center">회원가입</h2>

      <div>
        <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" id="name" name="name" required
               class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-400">
        <span id="nameCheckMsg" class="text-sm"></span>
      </div>

      <div>
        <label for="user_id" class="block text-sm font-medium text-gray-700">ID</label>
        <div class="flex items-center gap-2 mt-1">
          <input type="text" id="user_id" name="user_id" required
                 class="flex-1 px-3 py-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-400">
          <button type="button" id="btnUserId"
                  class="whitespace-nowrap bg-gray-900 text-white px-3 py-2 rounded-md text-sm">중복확인</button>
        </div>
        <span id="userIdMsg" class="text-sm"></span>
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">PassWord</label>
        <input type="password" id="password" name="password" required
               class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-400">
      </div>

      <div>
        <label for="password2" class="block text-sm font-medium text-gray-700">PassWord Check</label>
        <input type="password" id="password2" required
               class="mt-1 w-full px-3 py-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-400">
        <span id="pwdCheckMsg" class="text-sm"></span>
      </div>

      <div>
        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
        <div class="flex items-center gap-2 mt-1">
          <input type="email" id="email" name="email" required
                 class="flex-1 px-3 py-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-400">
          <button type="button" id="btnSendVerification"
                  class="whitespace-nowrap bg-gray-900 text-white px-3 py-2 rounded-md text-sm">메일발송</button>
        </div>
        <span id="emailMsg" class="text-sm"></span>
      </div>

      <div>
        <label for="emailCode" class="block text-sm font-medium text-gray-700">인증코드 입력</label>
        <div class="flex items-center gap-2 mt-1">
          <input type="text" id="emailCode"
                 class="flex-1 px-3 py-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-400">
          <button type="button" id="btnVerifyCode"
                  class="whitespace-nowrap bg-gray-900 text-white px-3 py-2 rounded-md text-sm">확인</button>
        </div>
        <span id="emailCodeMsg" class="text-sm"></span>
      </div>

      <div>
        <button type="submit" id="btnSend"
                class="w-full bg-indigo-500 text-white py-2 rounded-lg shadow hover:bg-indigo-600">회원가입</button>
      </div>
    </form>
  </div>

  <!-- Right: Logo -->
  <div class="w-1/2 bg-indigo-500 flex items-center justify-center">
    <img src="/images/logo1.png" alt="Savemate Logo" class="w-80 h-auto rounded-lg shadow-lg" />
  </div>
</div>



</body>
</html>
