<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>SAVEMATE - ì˜ˆì‚° ì„¤ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}"
    />
    <script th:inline="javascript">
        const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
    </script>
    <script>
        function csrfFetch(url, options = {}) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

            options.headers = {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken,
                ...(options.headers || {})
            };

            return fetch(url, {
                ...options,
                credentials: 'same-origin'
            });
        }



    </script>



</head>
<body class="bg-gray-50 font-sans">

<!-- âœ… Header (ì‚¬ìš©ì ì •ë³´ + ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í¬í•¨) -->
<!-- âœ… í—¤ë” --><header class="bg-white shadow border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap justify-between items-center">
        <!-- ì™¼ìª½: ë¡œê³  ë° ì‚¬ìš©ì ì •ë³´ -->
        <div class="flex items-center space-x-3">
            <h1 class="text-lg font-semibold text-gray-700">
                <span th:if="${#authorization.expression('isAuthenticated()')}" th:text="${#authentication.principal.username}">ì‚¬ìš©ì</span>
                <span th:if="${#authorization.expression('isAnonymous()')}">ê²ŒìŠ¤íŠ¸</span>
                ë‹˜ì˜ <span class="text-purple-600">SAVEMATE</span>
            </h1>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ë„¤ë¹„ê²Œì´ì…˜ + ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
        <div class="flex flex-wrap items-center space-x-6 mt-4 lg:mt-0">
            <nav>
                <ul class="flex space-x-6 text-base text-gray-700 font-semibold">
                    <li><a href="/dashboard/page" class="hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a></li>
                    <li><a href="/spending/page" class="hover:text-purple-600">ì†Œë¹„ë‚´ì—­</a></li>
                    <li><a href="/budget/page" class="hover:text-purple-600">ì˜ˆì‚° ì„¤ì •</a></li>
                    <li><a href="/goal/page" class="hover:text-purple-600">ì €ì¶•</a></li>
                    <li><a href="/user/myPage" class="hover:text-purple-600">ë§ˆì´í˜ì´ì§€</a></li>
                </ul>
            </nav>

            <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
            <div>
                <form th:if="${#authorization.expression('isAuthenticated()')}" th:action="@{/user/logout}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
                <a th:if="${#authorization.expression('isAnonymous()')}" th:href="@{/user/login}"
                   class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </div>
</header>

<!-- âœ… Main Content -->
<main class="max-w-5xl mx-auto p-6 bg-white rounded-lg shadow mt-8">
    <h2 class="text-2xl font-semibold mb-4">ì˜ˆì‚° ì„¤ì •</h2>
    <p id="authNotice" class="text-sm text-red-500 hidden">âš ï¸ ë¡œê·¸ì¸ í›„ ì˜ˆì‚°ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <!-- ì›”ë³„ ì˜ˆì‚° ì¡°íšŒ ì˜ì—­ -->
    <div class="mb-8">
        <form id="monthSearchForm" class="flex items-center space-x-2 mb-4">
            <label for="searchMonth" class="text-sm">ì›”ë³„ ì˜ˆì‚° ì¡°íšŒ</label>
            <input type="month" id="searchMonth" class="border rounded px-2 py-1" />
            <button type="button" id="searchBudgetBtn" class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition">ì¡°íšŒ</button>
        </form>
        <div id="monthlyBudgetResult">
            <!-- ì›”ë³„ ì˜ˆì‚° ê²°ê³¼ í…Œì´ë¸”ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ì…ë ¥ í¼ -->
    <form id="budgetForm" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
        <input type="hidden" id="budgetId" />

        <div class="md:col-span-2">
            <label class="text-sm">ì›” ì„ íƒ</label>
            <input type="month" id="budgetMonth" class="w-full border rounded px-3 py-2" />
        </div>

        <div class="md:col-span-2">
            <label class="text-sm">ì¹´í…Œê³ ë¦¬</label>
            <select id="budgetCategory" class="w-full border rounded px-3 py-2">
                <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                <option>ì‹ë¹„</option><option>êµí†µ/ì´ë™</option><option>ì£¼ê±°/ê³µê³¼ê¸ˆ</option>
                <option>ìƒí™œìš©í’ˆ</option><option>ì˜ë¥˜/ë¯¸ìš©</option><option>ì˜ë£Œ/ê±´ê°•</option>
                <option>êµìœ¡/ë„ì„œ</option><option>ì—¬ê°€/ë¬¸í™”</option><option>ê¸°íƒ€</option>
            </select>
        </div>

        <div class="md:col-span-1">
            <label class="text-sm">ì˜ˆì‚° ê¸ˆì•¡</label>
            <input type="number" id="totalBudget" class="w-full border rounded px-3 py-2" />
        </div>

        <div class="md:col-span-1 flex items-end">
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded w-full hover:bg-indigo-700">ì €ì¥</button>
        </div>
    </form>

    <!-- ì˜ˆì‚° ì¹´ë“œ ëª©ë¡ -->
    <div id="budgetList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- ì¹´ë“œ ë Œë”ë§ ì˜ì—­ -->
    </div>
</main>

<script>
    const apiUrl = '/budgetAPI';

    // âœ… ì´ˆê¸° ë¡œë”©
    window.onload = () => {
        if (!isAuthenticated) {
            document.getElementById('authNotice').classList.remove('hidden');
            document.querySelectorAll('#budgetForm input, #budgetForm select, #budgetForm button')
                .forEach(el => {
                    el.disabled = true;
                    el.classList.add('opacity-50', 'cursor-not-allowed');
                });
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì›” input ê¸°ë³¸ê°’ ì„¤ì •
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const thisMonth = `${yyyy}-${mm}`;
        document.getElementById('searchMonth').value = thisMonth;

        // í˜„ì¬ ì›” ì˜ˆì‚° ìë™ ì¡°íšŒ ë° ë Œë”ë§
        csrfFetch(`/budgetAPI/monthly?month=${thisMonth}`)
            .then(res => res.json())
            .then(data => renderBudgetCards(data));
    };


    // âœ… ì˜ˆì‚° í¼ ì œì¶œ ì²˜ë¦¬
    document.getElementById('budgetForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const rawId = document.getElementById('budgetId').value;
        const id = rawId && rawId !== 'undefined' && !isNaN(rawId) ? parseInt(rawId) : null;

        const dateVal = document.getElementById('budgetMonth').value;
        const [year, month] = dateVal.split('-');
        const category = document.getElementById('budgetCategory').value;
        const totalBudget = parseInt(document.getElementById('totalBudget').value);

        if (!year || !month || !category || !totalBudget) {
            alert('â— ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const payload = {
            year: parseInt(year),
            month: parseInt(month),
            category: category,
            total_budget: totalBudget,
            used_budget: 0
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${apiUrl}/${id}` : apiUrl;

        csrfFetch(url, {
            method,
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨');
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return res.json();
                } else {
                    return res.text();
                }
            })
            .then(() => {
                alert('âœ… ì €ì¥ ì™„ë£Œ');
                resetForm();
                // í˜„ì¬ ì„ íƒëœ ì›”ë¡œ ë‹¤ì‹œ ì¡°íšŒ
                const selectedMonth = document.getElementById('searchMonth').value;
                csrfFetch(`/budgetAPI/monthly?month=${selectedMonth}`)
                    .then(res => res.json())
                    .then(data => renderBudgetCards(data));
            })
            .catch(err => alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + err));
    });



    function resetForm() {
        document.getElementById('budgetForm').reset();
        document.getElementById('budgetId').value = '';
    }



    function loadBudgets() {
        fetch(apiUrl)
            .then(res => res.json())
            .then(renderBudgetCards);
    }
    // ì›”ë³„ ì˜ˆì‚° ì¡°íšŒ ê¸°ëŠ¥
    function renderBudgetCards(data) {
        const list = document.getElementById('budgetList');
        list.innerHTML = '';
        data.forEach(budget => {
            const total = budget.totalBudget != null ? Number(budget.totalBudget).toLocaleString() : '0';
            const used = budget.usedBudget != null ? Number(budget.usedBudget).toLocaleString() : '0';
            const remain = budget.remainingBudget != null ? Number(budget.remainingBudget).toLocaleString() : '0';
            const card = document.createElement('div');
            card.className = 'border rounded shadow p-4 bg-gray-50';
            card.innerHTML = `
            <h3 class="text-lg font-semibold mb-2 text-purple-600">${budget.category}</h3>
            <p><strong>ì—°ë„/ì›”:</strong> ${budget.year}ë…„ ${String(budget.month).padStart(2, '0')}ì›”</p>
            <p><strong>ì´ ì˜ˆì‚°:</strong> ${total}ì›</p>
            <p><strong>ì‚¬ìš©ì•¡:</strong> ${used}ì›</p>
            <p><strong>ë‚¨ì€ ê¸ˆì•¡:</strong> ${remain}ì›</p>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="editBudget(${budget.budgetId})" class="bg-yellow-400 text-white px-3 py-1 rounded hover:bg-yellow-500">ìˆ˜ì •</button>
                <button onclick="deleteBudget(${budget.budgetId})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">ì‚­ì œ</button>
            </div>
        `;
            list.appendChild(card);
        });
    }

    function editBudget(id) {
        fetch(`${apiUrl}/${id}`)
            .then(res => res.json())
            .then(data => {
                console.log('[DEBUG] ë¶ˆëŸ¬ì˜¨ budget:', data);

                document.getElementById('budgetId').value = data.budget_id ?? data.budgetId;
                document.getElementById('budgetMonth').value = `${data.year}-${String(data.month).padStart(2, '0')}`;
                document.getElementById('budgetCategory').value = data.category;
                document.getElementById('totalBudget').value = data.total_budget ?? data.totalBudget;
            })
            .catch(err => alert('âŒ ì˜ˆì‚° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err));
    }



    function deleteBudget(id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        csrfFetch(`${apiUrl}/${id}`, {
            method: 'DELETE'
        })
            .then(() => {
                alert('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ');
                // í˜„ì¬ ì„ íƒëœ ì›”ë¡œ ë‹¤ì‹œ ì¡°íšŒ
                const selectedMonth = document.getElementById('searchMonth').value;
                csrfFetch(`/budgetAPI/monthly?month=${selectedMonth}`)
                    .then(res => res.json())
                    .then(data => renderBudgetCards(data));
            })
            .catch(err => alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + err));
    }

    // ì›”ë³„ ì˜ˆì‚° ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ budgetListì— í‘œì‹œ
    document.getElementById('searchBudgetBtn').addEventListener('click', function() {
        const month = document.getElementById('searchMonth').value;
        if (!month) {
            alert('ì›”ì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }
        csrfFetch(`/budgetAPI/monthly?month=${month}`)
            .then(res => res.json())
            .then(data => {
                renderBudgetCards(data); // budgetListì— ì›”ë³„ ì˜ˆì‚° í‘œì‹œ
            })
            .catch(() => alert('ì˜ˆì‚° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
    });
</script>

</body>
</html>
